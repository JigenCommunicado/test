–∂–µ—Ç –±—ã<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Express SmartApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #4facfe;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 10px;
        }

        .btn-primary { background: #4facfe; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .logs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-warning { background: #fff3cd; color: #856404; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #4facfe;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SmartApp</h1>
            <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π Express SmartApp</p>
        </div>

        <div class="content">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="test-section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tests">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="passed-tests">0</div>
                        <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="failed-tests">0</div>
                        <div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="applications-created">0</div>
                        <div class="stat-label">–ó–∞—è–≤–æ–∫ —Å–æ–∑–¥–∞–Ω–æ</div>
                    </div>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã -->
            <div class="test-section">
                <h2>‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</h2>
                <button class="btn btn-primary" onclick="runQuickTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</button>
                <button class="btn btn-info" onclick="testHealthChecks()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health Check</button>
                <button class="btn btn-success" onclick="testStatistics()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <div id="quick-test-result"></div>
            </div>

            <!-- –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–æ–∫ -->
            <div class="test-section">
                <h2>üìù –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–æ–∫</h2>
                <div class="grid">
                    <div class="card">
                        <h4>–û–¥–∏–Ω–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞</h4>
                        <button class="btn btn-primary" onclick="createSingleApplication()">–°–æ–∑–¥–∞—Ç—å –æ–¥–Ω—É –∑–∞—è–≤–∫—É</button>
                        <div id="single-app-result"></div>
                    </div>
                    <div class="card">
                        <h4>–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏</h4>
                        <div class="form-group">
                            <label for="app-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫:</label>
                            <input type="number" id="app-count" value="3" min="1" max="10">
                        </div>
                        <button class="btn btn-success" onclick="createMultipleApplications()">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫–∏</button>
                        <div id="multiple-app-result"></div>
                    </div>
                </div>
            </div>

            <!-- –¢–µ—Å—Ç API -->
            <div class="test-section">
                <h2>üîß –¢–µ—Å—Ç API endpoints</h2>
                <div class="grid">
                    <div class="card">
                        <h4>–û—Å–Ω–æ–≤–Ω—ã–µ API</h4>
                        <button class="btn btn-primary" onclick="testBasicAPIs()">–¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö API</button>
                        <div id="basic-api-result"></div>
                    </div>
                    <div class="card">
                        <h4>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
                        <button class="btn btn-info" onclick="testCalendarAndDirections()">–¢–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</button>
                        <div id="calendar-directions-result"></div>
                    </div>
                </div>
            </div>

            <!-- –¢–µ—Å—Ç –æ—à–∏–±–æ–∫ -->
            <div class="test-section">
                <h2>‚ùå –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫</h2>
                <button class="btn btn-warning" onclick="testErrorHandling()">–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫</button>
                <div id="error-test-result"></div>
            </div>

            <!-- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç -->
            <div class="test-section">
                <h2>üöÄ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç</h2>
                <p>–ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π SmartApp</p>
                <button class="btn btn-success" onclick="runComprehensiveTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç</button>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div id="comprehensive-test-result"></div>
            </div>

            <!-- –õ–æ–≥–∏ -->
            <div class="test-section">
                <h2>üìã –õ–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                <button class="btn btn-info" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
                <button class="btn btn-primary" onclick="exportLogs()">–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤</button>
                <div class="logs" id="logs">
                    <div class="log-entry log-info">–õ–æ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            applications: 0
        };

        const TEST_SMARTAPP_URL = 'http://localhost:8081';
        const MAIN_SMARTAPP_URL = 'http://localhost:5002';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
        async function fetchWithCORS(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                return response;
            } catch (error) {
                console.error('CORS error, trying alternative method:', error);
                // –ü–æ–ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
                return fetch(`/proxy?url=${encodeURIComponent(url)}`, options);
            }
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            document.getElementById('applications-created').textContent = testStats.applications;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        // –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
        async function runQuickTests() {
            log('–ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤...', 'info');
            testStats.total += 3;
            
            try {
                // –¢–µ—Å—Ç 1: Health Check —Ç–µ—Å—Ç–æ–≤–æ–≥–æ SmartApp
                const response1 = await fetchWithCORS(`${TEST_SMARTAPP_URL}/api/health`);
                if (response1.ok) {
                    testStats.passed++;
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π SmartApp Health Check: OK', 'success');
                } else {
                    testStats.failed++;
                    log('‚ùå –¢–µ—Å—Ç–æ–≤—ã–π SmartApp Health Check: Failed', 'error');
                }

                // –¢–µ—Å—Ç 2: Health Check –æ—Å–Ω–æ–≤–Ω–æ–≥–æ SmartApp
                const response2 = await fetch(`${MAIN_SMARTAPP_URL}/health`);
                if (response2.ok) {
                    testStats.passed++;
                    log('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π SmartApp Health Check: OK', 'success');
                } else {
                    testStats.failed++;
                    log('‚ùå –û—Å–Ω–æ–≤–Ω–æ–π SmartApp Health Check: Failed', 'error');
                }

                // –¢–µ—Å—Ç 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const response3 = await fetch(`${TEST_SMARTAPP_URL}/api/statistics`);
                if (response3.ok) {
                    testStats.passed++;
                    log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: OK', 'success');
                } else {
                    testStats.failed++;
                    log('‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: Failed', 'error');
                }

                updateStats();
                showResult('quick-test-result', `–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã: ${testStats.passed}/${testStats.total} —É—Å–ø–µ—à–Ω–æ`, 'success');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤: ${error.message}`, 'error');
                showResult('quick-test-result', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç Health Check
        async function testHealthChecks() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Health Check...', 'info');
            
            try {
                const [testResponse, mainResponse] = await Promise.all([
                    fetch(`${TEST_SMARTAPP_URL}/api/health`),
                    fetch(`${MAIN_SMARTAPP_URL}/health`)
                ]);

                let result = 'Health Check —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:<br>';
                
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    result += `‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π SmartApp: ${data.app_name} v${data.version}<br>`;
                } else {
                    result += `‚ùå –¢–µ—Å—Ç–æ–≤—ã–π SmartApp: ${testResponse.status}<br>`;
                }

                if (mainResponse.ok) {
                    const data = await mainResponse.json();
                    result += `‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π SmartApp: ${data.app_name} v${data.version}<br>`;
                } else {
                    result += `‚ùå –û—Å–Ω–æ–≤–Ω–æ–π SmartApp: ${mainResponse.status}<br>`;
                }

                showResult('quick-test-result', result, 'info');
            } catch (error) {
                showResult('quick-test-result', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function testStatistics() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...', 'info');
            
            try {
                const response = await fetch(`${TEST_SMARTAPP_URL}/api/statistics`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const stats = data.statistics;
                    let result = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫:<br>';
                    for (const [oke, count] of Object.entries(stats)) {
                        result += `${oke}: ${count} –∑–∞—è–≤–æ–∫<br>`;
                    }
                    showResult('quick-test-result', result, 'success');
                } else {
                    showResult('quick-test-result', `–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${data.error || 'Unknown'}`, 'error');
                }
            } catch (error) {
                showResult('quick-test-result', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–π –∑–∞—è–≤–∫–∏
        async function createSingleApplication() {
            log('–°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–π –∑–∞—è–≤–∫–∏...', 'info');
            testStats.total++;
            
            try {
                const userId = `single_test_${Date.now()}`;
                const steps = [
                    { endpoint: '/api/start', data: { user_id: userId } },
                    { endpoint: '/api/select-location', data: { user_id: userId, location: '–ú–°–ö' } },
                    { endpoint: '/api/select-oke', data: { user_id: userId, oke: '–û–ö–≠ 1' } },
                    { endpoint: '/api/select-date', data: { user_id: userId, date: '25.09.2024' } },
                    { endpoint: '/api/select-position', data: { user_id: userId, position: '–ë–ü' } },
                    { endpoint: '/api/input-fio', data: { user_id: userId, fio: '–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤–∏—á', tab_num: '123456' } },
                    { endpoint: '/api/select-direction', data: { user_id: userId, direction: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥' } },
                    { endpoint: '/api/input-wishes', data: { user_id: userId, wishes: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞' } },
                    { endpoint: '/api/confirm', data: { user_id: userId } }
                ];

                for (const step of steps) {
                    const response = await fetch(`${TEST_SMARTAPP_URL}${step.endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(step.data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ ${step.endpoint}: ${response.status}`);
                    }
                }

                testStats.passed++;
                testStats.applications++;
                log('‚úÖ –û–¥–∏–Ω–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                showResult('single-app-result', '‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Excel!', 'success');
            } catch (error) {
                testStats.failed++;
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏: ${error.message}`, 'error');
                showResult('single-app-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
        async function createMultipleApplications() {
            const count = parseInt(document.getElementById('app-count').value);
            log(`–°–æ–∑–¥–∞–Ω–∏–µ ${count} –∑–∞—è–≤–æ–∫...`, 'info');
            testStats.total += count;
            
            let successCount = 0;
            
            for (let i = 0; i < count; i++) {
                try {
                    const userId = `multi_test_${i}_${Date.now()}`;
                    const locations = ['–ú–°–ö', '–°–ü–ë', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–°–æ—á–∏'];
                    const okeOptions = ['–û–ö–≠ 1', '–û–ö–≠ 2', '–û–ö–≠ 3', '–û–ö–≠ 4'];
                    const positions = ['–ë–ü', '–ë–ü BS', '–°–ë–≠', '–ò–ü–ë'];
                    
                    const steps = [
                        { endpoint: '/api/start', data: { user_id: userId } },
                        { endpoint: '/api/select-location', data: { user_id: userId, location: locations[i % locations.length] } },
                        { endpoint: '/api/select-oke', data: { user_id: userId, oke: okeOptions[i % okeOptions.length] } },
                        { endpoint: '/api/select-date', data: { user_id: userId, date: `${25 + i}.09.2024` } },
                        { endpoint: '/api/select-position', data: { user_id: userId, position: positions[i % positions.length] } },
                        { endpoint: '/api/input-fio', data: { user_id: userId, fio: `–¢–µ—Å—Ç ${i} –¢–µ—Å—Ç–æ–≤–∏—á`, tab_num: `${100000 + i}` } },
                        { endpoint: '/api/select-direction', data: { user_id: userId, direction: '–ú–æ—Å–∫–≤–∞' } },
                        { endpoint: '/api/input-wishes', data: { user_id: userId, wishes: `–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ${i + 1}` } },
                        { endpoint: '/api/confirm', data: { user_id: userId } }
                    ];

                    for (const step of steps) {
                        const response = await fetch(`${TEST_SMARTAPP_URL}${step.endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(step.data)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ ${step.endpoint}: ${response.status}`);
                        }
                    }

                    successCount++;
                    testStats.passed++;
                    testStats.applications++;
                    log(`‚úÖ –ó–∞—è–≤–∫–∞ ${i + 1} —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ`, 'success');
                } catch (error) {
                    testStats.failed++;
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ ${i + 1}: ${error.message}`, 'error');
                }
            }
            
            updateStats();
            showResult('multiple-app-result', `‚úÖ –°–æ–∑–¥–∞–Ω–æ ${successCount}/${count} –∑–∞—è–≤–æ–∫`, 'success');
        }

        // –¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö API
        async function testBasicAPIs() {
            log('–¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö API...', 'info');
            testStats.total += 4;
            
            const apis = [
                { name: 'Health Check', url: `${TEST_SMARTAPP_URL}/api/health` },
                { name: 'Statistics', url: `${TEST_SMARTAPP_URL}/api/statistics` },
                { name: 'Main Health', url: `${MAIN_SMARTAPP_URL}/health` },
                { name: 'Main Page', url: `${MAIN_SMARTAPP_URL}/` }
            ];

            let result = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API:<br>';
            
            for (const api of apis) {
                try {
                    const response = await fetch(api.url);
                    if (response.ok) {
                        testStats.passed++;
                        result += `‚úÖ ${api.name}: OK<br>`;
                        log(`‚úÖ ${api.name}: OK`, 'success');
                    } else {
                        testStats.failed++;
                        result += `‚ùå ${api.name}: ${response.status}<br>`;
                        log(`‚ùå ${api.name}: ${response.status}`, 'error');
                    }
                } catch (error) {
                    testStats.failed++;
                    result += `‚ùå ${api.name}: ${error.message}<br>`;
                    log(`‚ùå ${api.name}: ${error.message}`, 'error');
                }
            }
            
            updateStats();
            showResult('basic-api-result', result, 'info');
        }

        // –¢–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        async function testCalendarAndDirections() {
            log('–¢–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π...', 'info');
            testStats.total += 2;
            
            try {
                // –¢–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                const calendarResponse = await fetch(`${MAIN_SMARTAPP_URL}/api/calendar/2024/9`);
                if (calendarResponse.ok) {
                    const data = await calendarResponse.json();
                    testStats.passed++;
                    log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å: OK', 'success');
                } else {
                    testStats.failed++;
                    log('‚ùå –ö–∞–ª–µ–Ω–¥–∞—Ä—å: Failed', 'error');
                }

                // –¢–µ—Å—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                const directionsResponse = await fetch(`${MAIN_SMARTAPP_URL}/api/directions/–ú–°–ö`);
                if (directionsResponse.ok) {
                    const data = await directionsResponse.json();
                    testStats.passed++;
                    log('‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: OK', 'success');
                } else {
                    testStats.failed++;
                    log('‚ùå –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: Failed', 'error');
                }
                
                updateStats();
                showResult('calendar-directions-result', '‚úÖ –¢–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
            } catch (error) {
                testStats.failed++;
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: ${error.message}`, 'error');
                showResult('calendar-directions-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        async function testErrorHandling() {
            log('–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫...', 'info');
            testStats.total += 3;
            
            const errorTests = [
                { name: '–ü—É—Å—Ç–∞—è –ª–æ–∫–∞—Ü–∏—è', url: `${TEST_SMARTAPP_URL}/api/select-location`, data: { user_id: 'test', location: '' } },
                { name: '–ù–µ–≤–µ—Ä–Ω—ã–π endpoint', url: `${TEST_SMARTAPP_URL}/api/invalid`, data: {} },
                { name: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ', url: `${TEST_SMARTAPP_URL}/api/input-fio`, data: { user_id: 'test' } }
            ];

            let result = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫:<br>';
            
            for (const test of errorTests) {
                try {
                    const response = await fetch(test.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.data)
                    });
                    
                    if (response.status >= 400) {
                        testStats.passed++;
                        result += `‚úÖ ${test.name}: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (${response.status})<br>`;
                        log(`‚úÖ ${test.name}: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'success');
                    } else {
                        testStats.failed++;
                        result += `‚ùå ${test.name}: –û—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ (${response.status})<br>`;
                        log(`‚ùå ${test.name}: –û—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞`, 'error');
                    }
                } catch (error) {
                    testStats.passed++;
                    result += `‚úÖ ${test.name}: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ<br>`;
                    log(`‚úÖ ${test.name}: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'success');
                }
            }
            
            updateStats();
            showResult('error-test-result', result, 'info');
        }

        // –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç
        async function runComprehensiveTest() {
            log('–ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...', 'info');
            updateProgress(0);
            
            const tests = [
                { name: 'Health Checks', func: testHealthChecks },
                { name: 'Statistics', func: testStatistics },
                { name: 'Basic APIs', func: testBasicAPIs },
                { name: 'Calendar & Directions', func: testCalendarAndDirections },
                { name: 'Error Handling', func: testErrorHandling },
                { name: 'Single Application', func: createSingleApplication }
            ];

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                log(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${test.name}...`, 'info');
                updateProgress((i / tests.length) * 100);
                
                try {
                    await test.func();
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ ${test.name}: ${error.message}`, 'error');
                }
            }
            
            updateProgress(100);
            log('üéâ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
            showResult('comprehensive-test-result', `–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${testStats.passed}/${testStats.total} —É—Å–ø–µ—à–Ω–æ`, 'success');
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry log-info">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...</div>';
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
        function exportLogs() {
            const logs = document.getElementById('logs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smartapp_test_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('–õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', function() {
            log('üß™ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            log(`–¢–µ—Å—Ç–æ–≤—ã–π SmartApp: ${TEST_SMARTAPP_URL}`, 'info');
            log(`–û—Å–Ω–æ–≤–Ω–æ–π SmartApp: ${MAIN_SMARTAPP_URL}`, 'info');
            updateStats();
        });
    </script>
</body>
</html>
