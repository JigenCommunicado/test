<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ - SmartApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .results-section {
            padding: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            font-size: 1.1em;
            color: #666;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .applications-table th,
        .applications-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .applications-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .applications-table tr:hover {
            background: #f8f9fa;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .search-buttons {
                flex-direction: column;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .applications-table {
                font-size: 12px;
            }
            
            .applications-table th,
            .applications-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫</h1>
            <p>–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</p>
        </div>

        <div class="search-section">
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="searchQuery">–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</label>
                    <input type="text" id="searchQuery" placeholder="–§–ò–û, —Ç–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä, –¥–æ–ª–∂–Ω–æ—Å—Ç—å...">
                </div>

                <div class="form-group">
                    <label for="okeFilter">–û–ö–≠</label>
                    <select id="okeFilter">
                        <option value="">–í—Å–µ –û–ö–≠</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="positionFilter">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select id="positionFilter">
                        <option value="">–í—Å–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dateFrom">–î–∞—Ç–∞ –æ—Ç</label>
                    <input type="date" id="dateFrom">
                </div>

                <div class="form-group">
                    <label for="dateTo">–î–∞—Ç–∞ –¥–æ</label>
                    <input type="date" id="dateTo">
                </div>
            </form>

            <div class="search-buttons">
                <button type="button" class="btn btn-primary" onclick="searchApplications()">
                    üîç –ü–æ–∏—Å–∫
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
                <button type="button" class="btn btn-success" onclick="exportResults()">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">
                    –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                </div>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>

            <div id="statsCards" class="stats-cards" style="display: none;">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <p>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>

            <div id="errorMessage" class="error" style="display: none;">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
            </div>

            <div id="successMessage" class="success" style="display: none;">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ -->
            </div>

            <div id="resultsTable" style="display: none;">
                <table class="applications-table">
                    <thead>
                        <tr>
                            <th>–û–ö–≠</th>
                            <th>–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏</th>
                            <th>–§–ò–û</th>
                            <th>–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                            <th>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–æ–∫ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </tbody>
                </table>

                <div class="pagination" id="pagination">
                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                <p>üì≠ –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            </div>
        </div>
    </div>

    <script>
        const SMARTAPP_URL = 'http://localhost:5002';
        let currentPage = 1;
        let currentFilters = {};
        let totalPages = 1;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            searchApplications(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        async function loadFilterOptions() {
            try {
                const response = await fetch(`${SMARTAPP_URL}/api/filters/options`);
                const data = await response.json();

                if (data.success) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –û–ö–≠
                    const okeSelect = document.getElementById('okeFilter');
                    data.options.okes.forEach(oke => {
                        const option = document.createElement('option');
                        option.value = oke.name;
                        option.textContent = `${oke.name} (${oke.count})`;
                        okeSelect.appendChild(option);
                    });

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                    const positionSelect = document.getElementById('positionFilter');
                    data.options.positions.forEach(position => {
                        const option = document.createElement('option');
                        option.value = position;
                        option.textContent = position;
                        positionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }

        // –ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫
        async function searchApplications(page = 1) {
            currentPage = page;
            showLoading(true);
            hideMessages();

            try {
                const filters = {
                    query: document.getElementById('searchQuery').value,
                    oke: document.getElementById('okeFilter').value,
                    position: document.getElementById('positionFilter').value,
                    date_from: document.getElementById('dateFrom').value,
                    date_to: document.getElementById('dateTo').value,
                    page: page,
                    per_page: 20
                };

                currentFilters = filters;

                const response = await fetch(`${SMARTAPP_URL}/api/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                    showSuccess(`–ù–∞–π–¥–µ–Ω–æ ${data.pagination.total_count} –∑–∞—è–≤–æ–∫`);
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                showLoading(false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(data) {
            const resultsCount = document.getElementById('resultsCount');
            const resultsTable = document.getElementById('resultsTable');
            const noResults = document.getElementById('noResults');
            const tableBody = document.getElementById('applicationsTableBody');

            resultsCount.textContent = `–ù–∞–π–¥–µ–Ω–æ ${data.pagination.total_count} –∑–∞—è–≤–æ–∫ (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.pagination.page} –∏–∑ ${data.pagination.total_pages})`;

            if (data.applications.length === 0) {
                resultsTable.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            resultsTable.style.display = 'block';

            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            tableBody.innerHTML = '';

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            data.applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${app.oke || ''}</td>
                    <td>${app['–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏'] || ''}</td>
                    <td>${app['–§–ò–û'] || ''}</td>
                    <td>${app['–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä'] || ''}</td>
                    <td>${app['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || ''}</td>
                    <td>${app['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || ''}</td>
                    <td>${app['–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ'] || ''}</td>
                `;
                tableBody.appendChild(row);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updatePagination(data.pagination);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        function updatePagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            totalPages = pagination.total_pages;

            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            const prevButton = document.createElement('button');
            prevButton.textContent = '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è';
            prevButton.disabled = pagination.page <= 1;
            prevButton.onclick = () => searchApplications(pagination.page - 1);
            paginationDiv.appendChild(prevButton);

            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === pagination.page ? 'current-page' : '';
                pageButton.onclick = () => searchApplications(i);
                paginationDiv.appendChild(pageButton);
            }

            // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
            const nextButton = document.createElement('button');
            nextButton.textContent = '–°–ª–µ–¥—É—é—â–∞—è ‚Üí';
            nextButton.disabled = pagination.page >= pagination.total_pages;
            nextButton.onclick = () => searchApplications(pagination.page + 1);
            paginationDiv.appendChild(nextButton);
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('okeFilter').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            searchApplications(1);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        async function exportResults() {
            try {
                const response = await fetch(`${SMARTAPP_URL}/api/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentFilters)
                });

                const data = await response.json();

                if (data.success) {
                    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    window.open(`${SMARTAPP_URL}${data.download_url}`, '_blank');
                    showSuccess(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${data.count} –∑–∞—è–≤–æ–∫ –≤ —Ñ–∞–π–ª ${data.filename}`);
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function refreshData() {
            searchApplications(currentPage);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
    </script>
</body>
</html>


