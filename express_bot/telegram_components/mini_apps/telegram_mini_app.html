<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–π—Å - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-theme-text-color: var(--tg-theme-text-color, #000000);
            --tg-theme-button-color: var(--tg-theme-button-color, #0088cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-container {
            margin-bottom: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--tg-theme-button-color);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .step-info {
            text-align: center;
            margin-top: 8px;
            font-size: 14px;
            color: var(--tg-theme-text-color);
            opacity: 0.7;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .review-section {
            background: var(--tg-theme-secondary-bg-color);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 500;
            font-size: 14px;
        }

        .review-value {
            font-size: 14px;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .success-message {
            text-align: center;
            padding: 32px 16px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 24px;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid var(--tg-theme-secondary-bg-color);
            border-radius: 50%;
            border-top-color: var(--tg-theme-button-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .telegram-info {
            background: var(--tg-theme-secondary-bg-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è –ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–π—Å</h1>
            <div class="telegram-info" id="telegramInfo">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram...
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-info" id="stepInfo">–®–∞–≥ 1 –∏–∑ 8</div>
        </div>

        <form id="applicationForm">
            <!-- –®–∞–≥ 1: –õ–æ–∫–∞—Ü–∏—è -->
            <div class="form-step active" data-step="1">
                <div class="form-group">
                    <label for="location">üìç –õ–æ–∫–∞—Ü–∏—è:</label>
                    <select id="location" name="location" required onchange="updateDirections()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</option>
                        <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞</option>
                        <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                        <option value="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
                        <option value="–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                        <option value="–ö–∞–∑–∞–Ω—å">–ö–∞–∑–∞–Ω—å</option>
                        <option value="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</option>
                        <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫">–ß–µ–ª—è–±–∏–Ω—Å–∫</option>
                        <option value="–°–∞–º–∞—Ä–∞">–°–∞–º–∞—Ä–∞</option>
                        <option value="–û–º—Å–∫">–û–º—Å–∫</option>
                        <option value="–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É">–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É</option>
                    </select>
                </div>
            </div>

            <!-- –®–∞–≥ 2: –û–ö–≠ -->
            <div class="form-step" data-step="2">
                <div class="form-group">
                    <label for="oke">üè¢ –û–ö–≠:</label>
                    <select id="oke" name="oke" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –û–ö–≠</option>
                        <option value="–û–ö–≠ 1">–û–ö–≠ 1</option>
                        <option value="–û–ö–≠ 2">–û–ö–≠ 2</option>
                        <option value="–û–ö–≠ 3">–û–ö–≠ 3</option>
                        <option value="–û–ö–≠ 4">–û–ö–≠ 4</option>
                        <option value="–û–ö–≠ 5">–û–ö–≠ 5</option>
                    </select>
                </div>
            </div>

            <!-- –®–∞–≥ 3: –î–∞—Ç–∞ -->
            <div class="form-step" data-step="3">
                <div class="form-group">
                    <label for="date">üìÖ –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</label>
                    <input type="date" id="date" name="date" required>
                </div>
            </div>

            <!-- –®–∞–≥ 4: –î–æ–ª–∂–Ω–æ—Å—Ç—å -->
            <div class="form-step" data-step="4">
                <div class="form-group">
                    <label for="position">üë§ –î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                    <select id="position" name="position" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                        <option value="–ë–ü">–ë–ü</option>
                        <option value="–ë–ü BS">–ë–ü BS</option>
                        <option value="–°–ë">–°–ë</option>
                        <option value="–ò–ü–ë">–ò–ü–ë</option>
                    </select>
                </div>
            </div>

            <!-- –®–∞–≥ 5: –§–ò–û -->
            <div class="form-step" data-step="5">
                <div class="form-group">
                    <label for="fio">üìù –§–ò–û:</label>
                    <input type="text" id="fio" name="fio" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" required>
                </div>
            </div>

            <!-- –®–∞–≥ 6: –¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä -->
            <div class="form-step" data-step="6">
                <div class="form-group">
                    <label for="tab_num">üî¢ –¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä:</label>
                    <input type="text" id="tab_num" name="tab_num" placeholder="123456" required>
                </div>
            </div>

            <!-- –®–∞–≥ 7: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="form-step" data-step="7">
                <div class="form-group">
                    <label for="direction">üéØ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
                    <select id="direction" name="direction" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>
                    </select>
                </div>
            </div>

            <!-- –®–∞–≥ 8: –ü–æ–∂–µ–ª–∞–Ω–∏—è -->
            <div class="form-step" data-step="8">
                <div class="form-group">
                    <label for="wishes">üí≠ –ü–æ–∂–µ–ª–∞–Ω–∏—è:</label>
                    <textarea id="wishes" name="wishes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
            </div>

            <!-- –®–∞–≥ 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
            <div class="form-step" data-step="9">
                <h3>üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:</h3>
                <div class="review-section" id="reviewData">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </div>
            </div>

            <!-- –®–∞–≥ 10: –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
            <div class="form-step" data-step="10">
                <div class="success-message">
                    <div class="success-icon">‚úÖ</div>
                    <h3>–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3>
                    <p>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
                </div>
            </div>
        </form>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">–ù–∞–∑–∞–¥</button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        // Telegram Web App API
        let tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Mini App
        tg.ready();
        tg.expand();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        document.getElementById('telegramInfo').innerHTML = `
            üëã ${tg.initDataUnsafe.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} | 
            üì± Telegram Mini App
        `;

        let currentStep = 1;
        const totalSteps = 9;

        // –î–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
        const directionsData = {
            "–ú–æ—Å–∫–≤–∞": ["–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ö–∞–∑–∞–Ω—å", "–°–æ—á–∏"],
            "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥": ["–ú–æ—Å–∫–≤–∞", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥"],
            "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": ["–ú–æ—Å–∫–≤–∞", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫", "–ò—Ä–∫—É—Ç—Å–∫"],
            "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–¢—é–º–µ–Ω—å"],
            "–ö–∞–∑–∞–Ω—å": ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–£—Ñ–∞"],
            "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥": ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥"],
            "–ß–µ–ª—è–±–∏–Ω—Å–∫": ["–ú–æ—Å–∫–≤–∞", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"],
            "–°–∞–º–∞—Ä–∞": ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥"],
            "–û–º—Å–∫": ["–ú–æ—Å–∫–≤–∞", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥"],
            "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É": ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", "–°–æ—á–∏"]
        };

        function updateDirections() {
            const locationSelect = document.getElementById('location');
            const directionSelect = document.getElementById('direction');
            const selectedLocation = locationSelect.value;
            
            directionSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>';
            
            if (selectedLocation && directionsData[selectedLocation]) {
                directionsData[selectedLocation].forEach(direction => {
                    const option = document.createElement('option');
                    option.value = direction;
                    option.textContent = direction;
                    directionSelect.appendChild(option);
                });
            }
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('stepInfo').textContent = `–®–∞–≥ ${currentStep} –∏–∑ ${totalSteps}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —à–∞–≥
            const steps = document.querySelectorAll('.form-step');
            steps.forEach((step, index) => {
                step.classList.toggle('active', index + 1 === currentStep);
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            } else if (currentStep === totalSteps + 1) {
                document.getElementById('nextBtn').style.display = 'none';
            } else {
                document.getElementById('nextBtn').textContent = '–î–∞–ª–µ–µ';
            }
        }

        function validateCurrentStep() {
            const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    field.focus();
                    showError(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "${field.previousElementSibling.textContent}"`);
                    return false;
                }
            }
            
            return true;
        }

        function nextStep() {
            hideError();
            
            if (currentStep <= totalSteps - 1) {
                if (!validateCurrentStep()) {
                    return;
                }
            }
            
            if (currentStep === totalSteps - 1) {
                fillReviewData();
            }
            
            if (currentStep === totalSteps) {
                submitForm();
                return;
            }
            
            currentStep++;
            updateProgress();
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateProgress();
            }
        }

        function fillReviewData() {
            const form = document.getElementById('applicationForm');
            const formData = new FormData(form);
            const reviewContainer = document.getElementById('reviewData');
            
            const labels = {
                location: "üìç –õ–æ–∫–∞—Ü–∏—è",
                oke: "üè¢ –û–ö–≠", 
                date: "üìÖ –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞",
                position: "üë§ –î–æ–ª–∂–Ω–æ—Å—Ç—å",
                fio: "üìù –§–ò–û",
                tab_num: "üî¢ –¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä",
                direction: "üéØ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
                wishes: "üí≠ –ü–æ–∂–µ–ª–∞–Ω–∏—è"
            };
            
            let reviewHTML = '';
            for (let [key, value] of formData.entries()) {
                if (value && labels[key]) {
                    reviewHTML += `
                        <div class="review-item">
                            <span class="review-label">${labels[key]}:</span>
                            <span class="review-value">${value}</span>
                        </div>
                    `;
                }
            }
            
            reviewContainer.innerHTML = reviewHTML;
        }

        async function submitForm() {
            const form = document.getElementById('applicationForm');
            const formData = new FormData(form);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const telegramUser = tg.initDataUnsafe.user;
            if (telegramUser) {
                formData.append('telegram_user_id', telegramUser.id);
                formData.append('telegram_username', telegramUser.username || '');
                formData.append('telegram_first_name', telegramUser.first_name || '');
                formData.append('telegram_last_name', telegramUser.last_name || '');
            }
            
            const applicationData = {
                user_id: telegramUser?.id || 'telegram_' + Date.now(),
                location: formData.get('location'),
                oke: formData.get('oke'),
                date: formData.get('date'),
                position: formData.get('position'),
                fio: formData.get('fio'),
                tab_num: formData.get('tab_num'),
                direction: formData.get('direction'),
                wishes: formData.get('wishes') || '',
                source: 'telegram_mini_app',
                telegram_data: telegramUser ? {
                    user_id: telegramUser.id,
                    username: telegramUser.username,
                    first_name: telegramUser.first_name,
                    last_name: telegramUser.last_name
                } : null
            };
            
            showLoading(true);
            hideError();
            
            try {
                const response = await fetch('http://localhost:5002/api/application', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(applicationData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentStep = totalSteps + 1;
                    updateProgress();
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram –æ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
                    tg.showAlert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                    
                    // –ú–æ–∂–µ–º –∑–∞–∫—Ä—ã—Ç—å Mini App —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                    setTimeout(() => {
                        tg.close();
                    }, 3000);
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showError(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('nextBtn').disabled = show;
            document.getElementById('prevBtn').disabled = show;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É - —Å–µ–≥–æ–¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –§–ò–û –∏–∑ Telegram –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            const telegramUser = tg.initDataUnsafe.user;
            if (telegramUser) {
                const fullName = [telegramUser.first_name, telegramUser.last_name].filter(Boolean).join(' ');
                if (fullName) {
                    document.getElementById('fio').value = fullName;
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.onEvent('backButtonClicked', function() {
            if (currentStep > 1) {
                prevStep();
            } else {
                tg.close();
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram –∫–æ–≥–¥–∞ –Ω–µ –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ
        function updateTelegramBackButton() {
            if (currentStep > 1) {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —à–∞–≥–∞
        const originalUpdateProgress = updateProgress;
        updateProgress = function() {
            originalUpdateProgress();
            updateTelegramBackButton();
        };
    </script>
</body>
</html>
